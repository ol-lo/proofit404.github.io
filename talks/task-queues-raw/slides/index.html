<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="css/reveal.css">
        <link rel="stylesheet" type="text/css" href="css/theme/white.css">
        <link rel="stylesheet" type="text/css" href="lib/css/vs.css">
        <link rel="stylesheet" type="text/css" href="css/customize.css">
        <title>Task Queues Raw</title>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h2>Очереди задач</h2>
                    <h2>без купюр</h2>
                </section>
                <section>
                    <img src="pics/ask.png" class="double-face face-corner">
                    <img src="pics/celery.png" class="double-face">
                </section>
                <section>
                    <img src="pics/nvie.jpg" class="double-face face-corner">
                    <img src="pics/rq.png" class="double-face face-corner">
                </section>
                <section>
                    <img src="pics/rabbitmq.png"><br>
                    <img src="pics/direct-exchange.png">
                </section>
                <section>
                    <img src="pics/antirez.png" class="double-face face-corner">
                    <img src="pics/redis.png" class="double-face">
                </section>
                <section>
                    <h2>Submit</h2>
                    <pre>
                        <code class="hljs python">
# celery
add.delay(1, 2)

# rq
queue.enqueue(add, 1, 2)
                        </code>
                    </pre>
                </section>
                <section>
                    <h2>RabbitMQ queues</h2>
                    <table>
                        <tr>
                            <td style="text-align: center;">Name</td>
                            <td style="text-align: center;">Ready</td>
                            <td style="text-align: center;">Unacked</td>
                            <td style="text-align: center;">Total</td>
                        </tr>
                        <tr>
                            <td>celery</td>
                            <td style="text-align: right;">1</td>
                            <td style="text-align: right;">0</td>
                            <td style="text-align: right;">1</td>
                        </tr>
                    </table>
                </section>
                <section>
                    <h2>Payload</h2>
                    <pre>
                        <code class="hljs json">
{
    "chord": null,
    "args": [1, 2],
    "id": "27ebcaee-444f-4379-a438-04c3b5bb0fc3",
    "eta": null,
    "utc": true,
    "errbacks": null,
    "timelimit": [null, null],
    "kwargs": {},
    "taskset": null,
    "callbacks": null,
    "expires": null,
    "retries": 0,
    "task": "app.add"
}
                        </code>
                    </pre>
                </section>
                <section>
                    <h2>Redis queues</h2>
                    <pre>
                        <code class="hljs python" style="overflow: hidden;">
       >>> KEYS *
       1) "celery"
       >>> LRANGE celery 0 -1
       1) {
              "properties": {
                  "body_encoding": "base64",
                  "delivery_info": {
                      "exchange": "celery",
                      "routing_key": "celery"
                  }
              },
              "body": "eyJ0aW1lbGltaXQiOiBbbnVsb...",
              "headers": {},
              "content-encoding": "utf-8",
              "content-type": "application/json"
          }
                        </code>
                    </pre>
                </section>
                <section>
                    <h2>RQ</h2>
                    <pre>
                        <code class="hljs python">
>>> SMEMBERS rq:queues
1) "rq:queue:default"
>>> LRANGE rq:queue:default 0 -1
1) "be58515f-7031-4096-9572-9f330470995d"
>>> HGETALL rq:job:be58515f-7031-4096-9572-9f330470995d
1) "status"  "queued"
2) "enqueued_at" "2016-06-14T19:45:39Z"
3) "created_at" "2016-06-14T19:45:39Z"
4) "origin" "default"
5) "description" "lib.add(1, 2)"
6) "data" "\x80\x04\x95\x17\x00\x00..."
7) "timeout" "180"
                        </code>
                    </pre>
                </section>
                <section>
                    <h2>Accept task</h2>
                    <pre>
                        <code class="hljs bash">
# celery
$ celery -A myapp worker -Q queue1,queue2

# rq
$ rq worker queue1 queue2
                        </code>
                    </pre>
                </section>
                <section>
                    <h2>RabbitMQ queues</h2>
                    <table>
                        <tr>
                            <td style="text-align: center;">Name</td>
                            <td style="text-align: center;">Ready</td>
                            <td style="text-align: center;">Unacked</td>
                            <td style="text-align: center;">Total</td>
                        </tr>
                        <tr>
                            <td>celery</td>
                            <td style="text-align: right;">0</td>
                            <td style="text-align: right;">1</td>
                            <td style="text-align: right;">1</td>
                        </tr>
                    </table>
                </section>
                <section>
                    <h2>Redis queues</h2>
                    <pre>
                        <code class="hljs">
TODO
                        </code>
                    </pre>
                </section>
                <section>
                    <h2>RQ</h2>
                    <pre>
                        <code class="hljs">
TODO
                        </code>
                    </pre>
                </section>
                <section data-background="pics/iceberg.jpg" data-background-size="100%, auto">
                    <h1 style="color: white;">Fragile acknowledgment</h1>
                </section>
                <section data-background="pics/iceberg.jpg" data-background-size="100%, auto">
                    <h1 style="color: white;">rpoplpush</h1>
                    <h1 style="color: white;">lua scripts</h1>
                </section>
                <section data-background="pics/worker-monochrome-photo.jpg" data-background-size="contain">
                </section>
                <section data-background="pics/worker-celery-monochrome-photo.jpg" data-background-size="contain">
                </section>
                <section data-background="pics/redis-fork.jpg" data-background-size="contain" data-background-position="left">
                </section>
                <section>
                    <h2>Task execution</h2>
                    <pre>
                        <code class="hljs python">
# celery
def trace_task(uuid, args, kwargs, request=None):
    R = retval = fun(*args, **kwargs)

# rq
class Job:
    def perform(self):
        self._result = self.func(*self.args, **self.kwargs)
                        </code>
                    </pre>
                </section>
                <section>
                    <h2>concurrency</h2>
                    <ul>
                        &#x2713; gevent<br>
                        &#x2717; twisted<br>
                        &#x2717; tornado<br>
                        &#x2717; asyncio<br>
                    </ul>
                </section>
                <section data-background="pics/timeout-dog.jpg" data-background-size="100%, auto">
                </section>
                <section data-background="pics/rate-limit.jpg" data-background-size="100%, auto">
                </section>
                <section data-background="pics/train-crash.jpg" data-background-size="contain">
                </section>
                <section data-background="pics/eta.jpg" data-background-size="100%, auto">
                </section>
                <section data-background="pics/rabbit_dont_come_easy.jpg" data-background-size="contain">
                </section>
                <section data-background="pics/rb.svg" data-background-size="contain">
                </section>
            </div>
        </div>
        <script type="text/javascript" src="lib/js/head.min.js"></script>
        <script type="text/javascript" src="js/reveal.js"></script>
        <script type="text/javascript">
         Reveal.initialize({
             controls: false,
             progress: false,
             history: true,
             center: true,
             transition: 'slide',
             dependencies: [
                 { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
             ]
         });
        </script>
    </body>
</html>
